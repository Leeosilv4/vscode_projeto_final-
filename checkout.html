<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Manulo Pizzaria</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<header>
  <div class="header-content">
    <h1>✅ Finalizar Pedido</h1>
    <p>Último passo para saborear sua pizza!</p>
  </div>
  <button class="btn-voltar" onclick="window.history.back()">← Voltar</button>
</header>

<div class="carrinho-icone" onclick="window.location.href='carrinho.html'">
  🛒 <span id="contador-carrinho">0</span>
</div>

<main class="main-container">
  <div class="checkout-grid">
    <!-- Coluna 1: Resumo e Informações -->
    <div class="checkout-col">
      <!-- Resumo do Pedido -->
      <section class="checkout-section">
        <h2>📦 Resumo do Pedido</h2>
        <div class="resumo-pedido" id="resumo-pedido">
          <!-- Itens serão carregados aqui -->
        </div>
        <div class="resumo-total">
          <div class="resumo-linha">
            <span>Subtotal:</span>
            <span id="resumo-subtotal">R$ 0,00</span>
          </div>
          <div class="resumo-linha">
            <span>Taxa de entrega:</span>
            <span id="resumo-taxa">R$ 5,00</span>
          </div>
          <div class="resumo-linha total">
            <span><strong>Total:</strong></span>
            <span><strong id="resumo-total">R$ 0,00</strong></span>
          </div>
        </div>
      </section>

      <!-- Informações de Entrega -->
      <section class="checkout-section">
        <h2>🚚 Informações de Entrega</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="nome" class="form-label">👤 Nome Completo *</label>
            <input type="text" id="nome" class="form-input" placeholder="Seu nome completo" required>
          </div>

          <div class="form-group">
            <label for="telefone" class="form-label">📞 WhatsApp *</label>
            <input type="tel" id="telefone" class="form-input" placeholder="(11) 99999-9999" required>
          </div>

          <div class="form-group">
            <label for="endereco" class="form-label">📍 Endereço de Entrega *</label>
            <input type="text" id="endereco" class="form-input" placeholder="Rua, número, bairro, complemento..." required>
          </div>

          <div class="form-group">
            <label for="referencia" class="form-label">🏠 Ponto de Referência</label>
            <input type="text" id="referencia" class="form-input" placeholder="Próximo ao...">
          </div>

          <div class="form-group">
            <label for="observacoes" class="form-label">📝 Observações do Pedido</label>
            <textarea id="observacoes" class="form-input textarea" placeholder="Alguma observação especial? (opcional)"></textarea>
          </div>
        </div>
      </section>
    </div>

    <!-- Coluna 2: Pagamento e Ações -->
    <div class="checkout-col">
      <!-- Forma de Pagamento -->
      <section class="checkout-section">
        <h2>💳 Forma de Pagamento</h2>
        <div class="pagamento-opcoes">
          <label class="pagamento-option">
            <input type="radio" name="pagamento" value="dinheiro" checked>
            <span class="pagamento-info">
              <span class="pagamento-icon">💵</span>
              <span class="pagamento-texto">
                <strong>Dinheiro</strong>
                <small>Troco para quanto?</small>
              </span>
            </span>
          </label>

          <label class="pagamento-option">
            <input type="radio" name="pagamento" value="cartao">
            <span class="pagamento-info">
              <span class="pagamento-icon">💳</span>
              <span class="pagamento-texto">
                <strong>Cartão</strong>
                <small>Débito ou Crédito</small>
              </span>
            </span>
          </label>

          <label class="pagamento-option">
            <input type="radio" name="pagamento" value="pix">
            <span class="pagamento-info">
              <span class="pagamento-icon">📱</span>
              <span class="pagamento-texto">
                <strong>PIX</strong>
                <small>Pagamento instantâneo</small>
              </span>
            </span>
          </label>
        </div>

        <!-- Campo Troco -->
        <div class="troco-field" id="campo-troco">
          <label for="troco" class="form-label">💵 Troco para quanto?</label>
          <input type="number" id="troco" class="form-input" placeholder="Ex: 50,00" step="0.01" min="0">
        </div>
      </section>

      <!-- Informações de Entrega -->
      <section class="checkout-section">
        <h2>⏰ Previsão de Entrega</h2>
        <div class="info-entrega-card">
          <div class="info-item">
            <span class="info-icon">🚚</span>
            <div class="info-texto">
              <strong>30-40 minutos</strong>
              <small>Tempo médio de entrega</small>
            </div>
          </div>
          <div class="info-item">
            <span class="info-icon">📍</span>
            <div class="info-texto">
              <strong>Entregamos</strong>
              <small>Em toda área urbana</small>
            </div>
          </div>
          <div class="info-item">
            <span class="info-icon">📞</span>
            <div class="info-texto">
              <strong>Dúvidas?</strong>
              <small>(11) 9999-9999</small>
            </div>
          </div>
        </div>
      </section>

      <!-- Ação Final -->
      <section class="checkout-section">
        <button class="btn btn-success btn-grande btn-block" id="enviar-pedido">
          📲 Enviar Pedido via WhatsApp
        </button>
        
        <div class="checkout-aviso">
          <p>🔒 Seus dados estão seguros. Ao enviar, você será redirecionado para o WhatsApp para confirmar o pedido.</p>
        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  <p>© 2025 Manulo Pizzaria - Sabor em cada fatia 🍕</p>
</footer>

<div id="toast"></div>

<script type="module">
import { atualizarCarrinho, obterCarrinho, mostrarToast } from './script.js';

const TAXA_ENTREGA = 5;

// Inicialização
atualizarCarrinho();
carregarResumo();

// Carregar resumo do pedido
function carregarResumo() {
  const carrinho = obterCarrinho();
  const resumo = document.getElementById("resumo-pedido");
  let subtotal = 0;

  resumo.innerHTML = "";

  if (carrinho.length === 0) {
    resumo.innerHTML = '<p class="vazio">Seu carrinho está vazio</p>';
    return;
  }

  carrinho.forEach(item => {
    const precoItem = item.price * item.quantidade;
    subtotal += precoItem;
    
    const div = document.createElement("div");
    div.classList.add("resumo-item");
    div.innerHTML = `
      <span class="resumo-quantidade">${item.quantidade}x</span>
      <span class="resumo-nome">${item.name}</span>
      <span class="resumo-preco">R$ ${precoItem.toFixed(2).replace(".", ",")}</span>
    `;
    resumo.appendChild(div);
  });

  const total = subtotal + TAXA_ENTREGA;
  
  document.getElementById("resumo-subtotal").textContent = `R$ ${subtotal.toFixed(2).replace(".", ",")}`;
  document.getElementById("resumo-taxa").textContent = `R$ ${TAXA_ENTREGA.toFixed(2).replace(".", ",")}`;
  document.getElementById("resumo-total").textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;
}

// Controle do campo troco
document.querySelectorAll('input[name="pagamento"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const campoTroco = document.getElementById('campo-troco');
    campoTroco.style.display = this.value === 'dinheiro' ? 'block' : 'none';
  });
});

// Enviar pedido
document.getElementById("enviar-pedido").addEventListener("click", function() {
  const nome = document.getElementById("nome").value.trim();
  const telefone = document.getElementById("telefone").value.trim();
  const endereco = document.getElementById("endereco").value.trim();
  const referencia = document.getElementById("referencia").value.trim();
  const observacoes = document.getElementById("observacoes").value.trim();
  const formaPagamento = document.querySelector('input[name="pagamento"]:checked').value;
  const troco = document.getElementById("troco").value;

  // Validações
  if (!nome || !telefone || !endereco) {
    mostrarToast("Preencha todos os campos obrigatórios!", "erro");
    return;
  }

  if (telefone.replace(/\D/g, "").length < 10) {
    mostrarToast("Digite um WhatsApp válido!", "erro");
    return;
  }

  const carrinho = obterCarrinho();
  if (carrinho.length === 0) {
    mostrarToast("Seu carrinho está vazio!", "erro");
    return;
  }

  // Construir mensagem
  let mensagem = `*🍕 PEDIDO - MANULO PIZZARIA*%0A%0A`;
  mensagem += `*Cliente:* ${nome}%0A`;
  mensagem += `*WhatsApp:* ${telefone}%0A`;
  mensagem += `*Endereço:* ${endereco}%0A`;
  
  if (referencia) {
    mensagem += `*Referência:* ${referencia}%0A`;
  }
  
  mensagem += `%0A*📦 ITENS DO PEDIDO:*%0A`;
  
  let subtotal = 0;
  carrinho.forEach(item => {
    const precoItem = item.price * item.quantidade;
    subtotal += precoItem;
    mensagem += `• ${item.quantidade}x ${item.name} - R$ ${precoItem.toFixed(2).replace(".", ",")}%0A`;
  });

  const total = subtotal + TAXA_ENTREGA;
  
  mensagem += `%0A*💰 RESUMO DO PEDIDO:*%0A`;
  mensagem += `Subtotal: R$ ${subtotal.toFixed(2).replace(".", ",")}%0A`;
  mensagem += `Taxa de entrega: R$ ${TAXA_ENTREGA.toFixed(2).replace(".", ",")}%0A`;
  mensagem += `*TOTAL: R$ ${total.toFixed(2).replace(".", ",")}*%0A%0A`;
  
  mensagem += `*💳 FORMA DE PAGAMENTO:*%0A`;
  const formas = {
    dinheiro: 'Dinheiro' + (troco ? ` (Troco para R$ ${parseFloat(troco).toFixed(2).replace(".", ",")})` : ''),
    cartao: 'Cartão',
    pix: 'PIX'
  };
  mensagem += `${formas[formaPagamento]}%0A%0A`;
  
  if (observacoes) {
    mensagem += `*📝 OBSERVAÇÕES:*%0A${observacoes}%0A%0A`;
  }
  
  mensagem += `_Pedido gerado via site_`;

  const telefoneLimpo = telefone.replace(/\D/g, "");
  const link = `https://wa.me/55${telefoneLimpo}?text=${mensagem}`;
  
  // Efeito visual de loading
  this.classList.add('loading');
  this.innerHTML = '⏳ Enviando...';
  
  setTimeout(() => {
    window.open(link, "_blank");
    this.classList.remove('loading');
    this.innerHTML = '📲 Enviar Pedido via WhatsApp';
    
    // Limpar carrinho após envio
    localStorage.removeItem("carrinho");
    atualizarCarrinho();
    
    mostrarToast("Pedido enviado com sucesso! Redirecionando...", "sucesso");
    
    // Redirecionar para página de confirmação
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }, 1000);
});

// Máscara para telefone
document.getElementById("telefone").addEventListener("input", function(e) {
  let value = e.target.value.replace(/\D/g, "");
  if (value.length > 11) value = value.substring(0, 11);
  
  if (value.length > 6) {
    value = value.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
  } else if (value.length > 2) {
    value = value.replace(/(\d{2})(\d{0,5})/, "($1) $2");
  }
  e.target.value = value;
});
</script>
</body>
</html>